<!doctype html>
<html>
<head>
  <title>BabelPod with actual piping</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body {
      margin:0;
      padding:0;
      font-family: sans-serif;
      background: #f3f4f6;
      color: #333;
    }
    h1 {
      background: #374151;
      color: #fff;
      padding: 1rem;
      margin: 0;
      text-align:center;
    }
    .container {
      max-width: 540px;
      margin: 1rem auto;
      padding: 1rem;
      background: #fff;
      border-radius: 8px;
    }
    label {
      display: block;
      margin-top:1rem;
      font-weight:600;
      font-size:1rem;
    }
    select {
      width:100%;
      margin:0.5rem 0;
    }
    #outputVolume {
      width:100%;
      margin:0.5rem 0;
    }
    .checkbox-list {
      padding:0.5rem;
      border: 1px solid #ccc;
      border-radius:8px;
      background: #f9fafb;
    }
    .checkbox-list label {
      display:flex;
      align-items:center;
      margin:0.3rem 0;
    }
    .checkbox-list input[type=checkbox] {
      margin-right:0.5rem;
      transform: scale(1.2);
    }
    .info-block {
      margin-top:1rem;
      background:#fdfaea;
      padding:1rem;
      border-radius:6px;
      border:1px solid #ece5c5;
    }
  </style>
</head>
<body>
  <h1>BabelPod</h1>
  <div class="container">
    <label>Input Device</label>
    <select id="inputSelect" size="4"></select>

    <label>Volume</label>
    <input id="volumeRange" type="range" min="0" max="100" value="50" />

    <label>Outputs</label>
    <div class="checkbox-list" id="outputsArea"></div>

    <div class="info-block">
      <p><strong>Current Input:</strong> <span id="curInputText">void</span></p>
      <p><strong>Current Volume:</strong> <span id="curVolumeText">50</span></p>
      <p><strong>Current Outputs:</strong></p>
      <ul id="curOutputsList"></ul>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    let currentInput = "void";
    let currentVolume= 50;
    let currentOutputs=[];

    const inputSel = document.getElementById('inputSelect');
    const volumeEl = document.getElementById('volumeRange');
    const outputsArea = document.getElementById('outputsArea');

    const curInputText = document.getElementById('curInputText');
    const curVolumeText= document.getElementById('curVolumeText');
    const curOutputsList= document.getElementById('curOutputsList');

    function refreshOutputsList() {
      // remove all
      while(curOutputsList.firstChild) curOutputsList.removeChild(curOutputsList.firstChild);
      currentOutputs.forEach(o=>{
        let li = document.createElement('li');
        li.textContent=o;
        curOutputsList.appendChild(li);
      });
    }

    // Socket handlers
    socket.on('available_inputs', function(list){
      // rebuild inputSel
      while(inputSel.firstChild) inputSel.removeChild(inputSel.firstChild);
      list.forEach(item=>{
        let opt=document.createElement('option');
        opt.value=item.id;
        opt.textContent=item.name;
        inputSel.appendChild(opt);
      });
      inputSel.value=currentInput;
    });

    socket.on('available_outputs', function(unified){
      // each => {uiId, name, isStereo, devices[]}
      while(outputsArea.firstChild) outputsArea.removeChild(outputsArea.firstChild);

      unified.forEach(u=>{
        let lb = document.createElement('label');
        let cb = document.createElement('input');
        cb.type='checkbox';
        cb.value=u.uiId;
        cb.checked=currentOutputs.includes(u.uiId);
        cb.addEventListener('change', onOutputCheckboxChange);
        lb.appendChild(cb);
        lb.appendChild(document.createTextNode(u.name));
        outputsArea.appendChild(lb);
      });
      refreshOutputsList();
    });

    socket.on('switched_input', function(val){
      currentInput=val;
      inputSel.value=val;
      curInputText.textContent=val;
    });
    socket.on('switched_output', function(outArr){
      if(!Array.isArray(outArr)) outArr=[outArr];
      currentOutputs=outArr;
      let cbs= outputsArea.querySelectorAll('input[type=checkbox]');
      cbs.forEach(cb=>{
        cb.checked= outArr.includes(cb.value);
      });
      refreshOutputsList();
    });
    socket.on('changed_output_volume', function(vol){
      currentVolume=vol;
      volumeEl.value=vol;
      curVolumeText.textContent=vol;
    });

    function onOutputCheckboxChange(ev){
      let cbs= outputsArea.querySelectorAll('input[type=checkbox]');
      let sel=[];
      cbs.forEach(cb=>{
        if(cb.checked) sel.push(cb.value);
      });
      socket.emit('switch_output', sel);
    }

    // UI
    inputSel.addEventListener('change', ev=>{
      socket.emit('switch_input', ev.target.value);
    });
    volumeEl.addEventListener('input', ev=>{
      socket.emit('change_output_volume', ev.target.value);
    });

  </script>
</body>
</html>