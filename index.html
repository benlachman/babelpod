<!DOCTYPE html>
<html>
  <head>
    <title>BabelPod</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      input[type="range"] {
        -webkit-appearance: none;
        width: 100%;
        height: 6px;
        background: transparent;
        border-radius: 3px;
        outline: none;
        cursor: pointer;
      }
      input[type="range"]::-webkit-slider-runnable-track {
        background: linear-gradient(
          to right,
          #920000 0%,
          #fe0000 var(--progress),
          #666 var(--progress),
          #666 100%
        );
        height: 6px;
        border-radius: 3px;
      }
      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        background: #ccc;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        margin-top: -5px;
        cursor: pointer;
        box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.3);
      }
      input[type="range"]::-moz-range-track {
        background: linear-gradient(to right, #999 0%, #666 100%);
        height: 6px;
        border-radius: 3px;
      }
      input[type="range"]::-moz-range-thumb {
        background: #ccc;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        cursor: pointer;
      }
      input[type="range"]::-ms-track {
        background: transparent;
        height: 6px;
        border-radius: 3px;
        border: none;
        color: transparent;
      }
      input[type="range"]::-ms-fill-lower {
        background: #ccc;
        border-radius: 3px;
      }
      input[type="range"]::-ms-fill-upper {
        background: #666;
        border-radius: 3px;
      }
      input[type="range"]::-ms-thumb {
        background: #ccc;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        cursor: pointer;
      }
      input[type="range"]:focus {
        outline: none;
      }
      input[type="range"]:hover::-webkit-slider-thumb {
        background: #ddd;
      }

      body {
        margin: 0;
        padding: 0;
        background: #121212;
        color: #ddd;
        font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      }
      header {
        background: #1f1f1f;
        padding: 1rem;
        text-align: center;
        font-size: 1.5rem;
      }
      .container {
        max-width: 540px;
        margin: 0 auto;
        padding: 1rem;
      }
      label {
        display: block;
        margin: 1rem 0 0.25rem;
        font-weight: 500;
      }
      .checkbox-list {
        background: #2a2a2a;
        border: 1px solid #444;
        border-radius: 6px;
        padding: 0.5rem;
      }
      .checkbox-list label {
        display: flex;
        align-items: center;
        margin: 0.4rem 0;
      }
      .checkbox-list input[type="checkbox"] {
        margin-right: 0.5rem;
        transform: scale(1.2);
      }
      .info {
        background: #1f1f1f;
        margin-top: 1rem;
        padding: 1rem;
        border-radius: 6px;
        font-size: 0.9rem;
      }

      /* Session overlay */
      #sessionOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.75);
        color: #fff;
        display: none;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        z-index: 9999;
      }
      #sessionOverlay button {
        margin-top: 1rem;
        padding: 0.5rem 1rem;
        font-size: 1rem;
        background: #444;
        border: none;
        border-radius: 4px;
        color: white;
        cursor: pointer;
      }
      #sessionOverlay button:hover {
        background: #666;
      }
    </style>
  </head>
  <body>
    <header>BabelPod</header>
    <div class="container">
      <label for="inputSelect">Input Device</label>
      <select id="inputSelect" size="4"></select>

      <label for="outputVolume">Volume</label>
      <input type="range" min="0" max="100" value="50" id="outputVolume" />

      <label>Outputs</label>
      <div class="checkbox-list" id="outputsList"></div>

      <div class="info">
        <p>Current Input: <span id="curInputText"></span></p>
        <p>Current Volume: <span id="curVolumeText"></span></p>
        <p>Active Outputs:</p>
        <ul id="activeOutputs"></ul>
        <p id="statusMessage" style="color: #4CAF50; margin-top: 1rem;"></p>
        <p id="errorMessage" style="color: #f44336; margin-top: 0.5rem;"></p>
      </div>
    </div>

    <div id="sessionOverlay">
      <h1>You are not controlling BabelPod</h1>
      <p>Another user is controlling. You can take over.</p>
      <button id="takeOverBtn">Take Over Control</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const rangeInput = document.querySelector('input[type="range"]');

      function updateSliderProgress() {
        const value = rangeInput.value;
        const max = rangeInput.max || 100;
        const percentage = (value / max) * 100;
        rangeInput.style.setProperty("--progress", `${percentage}%`);
      }

      rangeInput.addEventListener("input", updateSliderProgress);
      updateSliderProgress();

      const socket = io();

      let currentInput = "void";
      let currentVolume = 50;
      let currentOutputs = [];
      let isOwner = false;

      const inputSelect = document.getElementById("inputSelect");
      const volumeRange = document.getElementById("outputVolume");
      const outputsListDiv = document.getElementById("outputsList");
      const curInputText = document.getElementById("curInputText");
      const curVolumeText = document.getElementById("curVolumeText");
      const activeOutputsUl = document.getElementById("activeOutputs");
      const sessionOverlay = document.getElementById("sessionOverlay");
      const takeOverBtn = document.getElementById("takeOverBtn");
      const statusMessage = document.getElementById("statusMessage");
      const errorMessage = document.getElementById("errorMessage");

      let statusTimeout = null;
      let errorTimeout = null;

      function showStatus(message, duration = 5000) {
        statusMessage.textContent = message;
        errorMessage.textContent = "";
        if (statusTimeout) clearTimeout(statusTimeout);
        statusTimeout = setTimeout(() => {
          statusMessage.textContent = "";
        }, duration);
      }

      function showError(message, duration = 10000) {
        errorMessage.textContent = message;
        statusMessage.textContent = "";
        if (errorTimeout) clearTimeout(errorTimeout);
        errorTimeout = setTimeout(() => {
          errorMessage.textContent = "";
        }, duration);
      }

      function renderActiveOutputs() {
        while (activeOutputsUl.firstChild) {
          activeOutputsUl.removeChild(activeOutputsUl.firstChild);
        }
        currentOutputs.forEach((o) => {
          let li = document.createElement("li");
          li.textContent = o;
          activeOutputsUl.appendChild(li);
        });
      }

      // Overlay logic
      function updateOverlay() {
        if (isOwner) {
          sessionOverlay.style.display = "none";
        } else {
          sessionOverlay.style.display = "flex";
        }
      }
      takeOverBtn.addEventListener("click", () => {
        socket.emit("user_takeover");
      });

      // Socket events
      socket.on("available_inputs", (list) => {
        while (inputSelect.firstChild)
          inputSelect.removeChild(inputSelect.firstChild);
        list.forEach((item) => {
          const opt = document.createElement("option");
          opt.value = item.id;
          opt.textContent = item.name;
          inputSelect.appendChild(opt);
        });
        inputSelect.value = currentInput;
      });
      socket.on("available_outputs", (unified) => {
        while (outputsListDiv.firstChild)
          outputsListDiv.removeChild(outputsListDiv.firstChild);
        unified.forEach((u) => {
          let lb = document.createElement("label");
          let c = document.createElement("input");
          c.type = "checkbox";
          c.value = u.uiId;
          c.checked = currentOutputs.includes(u.uiId);
          c.addEventListener("change", onOutputCheckChange);
          lb.appendChild(c);
          lb.appendChild(document.createTextNode(u.name));
          outputsListDiv.appendChild(lb);
        });
        renderActiveOutputs();
      });
      socket.on("switched_input", (inp) => {
        currentInput = inp;
        inputSelect.value = inp;
        curInputText.textContent = inp;
      });
      socket.on("switched_output", (outs) => {
        if (!Array.isArray(outs)) outs = [outs];
        currentOutputs = outs;
        const allChecks = outputsListDiv.querySelectorAll(
          "input[type=checkbox]"
        );
        allChecks.forEach((ch) => {
          ch.checked = currentOutputs.includes(ch.value);
        });
        renderActiveOutputs();
      });
      socket.on("changed_output_volume", (vol) => {
        currentVolume = vol;
        volumeRange.value = vol;
        curVolumeText.textContent = String(vol);
        updateSliderProgress(); // Fix: Update slider background when server changes volume
      });
      socket.on("sessionOwnerUpdate", (ownerId) => {
        isOwner = socket.id === ownerId;
        updateOverlay();
      });
      socket.on("sessionLostControl", () => {
        // We are no longer the owner
        isOwner = false;
        updateOverlay();
      });

      // Add connection status handlers
      socket.on("connect", () => {
        showStatus("Connected to BabelPod server");
      });

      socket.on("disconnect", () => {
        showError("Disconnected from server. Attempting to reconnect...");
      });

      socket.on("connect_error", (error) => {
        showError("Connection error: " + error.message);
      });

      socket.on("error", (error) => {
        showError("Socket error: " + (error.message || error));
      });

      // Server-side error reporting
      socket.on("server_error", (data) => {
        showError("Server error: " + data.message);
      });

      socket.on("server_status", (data) => {
        showStatus(data.message);
      });

      function onOutputCheckChange(e) {
        const cbs = outputsListDiv.querySelectorAll("input[type=checkbox]");
        const sel = [];
        cbs.forEach((cb) => {
          if (cb.checked) sel.push(cb.value);
        });
        
        // Debounce output changes to prevent rapid switching
        if (window.outputChangeTimeout) clearTimeout(window.outputChangeTimeout);
        window.outputChangeTimeout = setTimeout(() => {
          socket.emit("switch_output", sel);
        }, 150);
      }

      inputSelect.addEventListener("change", (ev) => {
        socket.emit("switch_input", ev.target.value);
      });

      // Debounce volume changes to prevent flooding the server
      let volumeChangeTimeout = null;
      volumeRange.addEventListener("input", (ev) => {
        // Update UI immediately for smooth slider movement
        updateSliderProgress();
        
        // Debounce the socket emission
        if (volumeChangeTimeout) clearTimeout(volumeChangeTimeout);
        volumeChangeTimeout = setTimeout(() => {
          socket.emit("change_output_volume", ev.target.value);
        }, 100);
      });
    </script>
  </body>
</html>
